<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>High Impact Shared Savings</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .container {
      max-width: 1000px;
      margin: auto;
    }
    h1, h2, h3 {
      margin: 10px 0;
    }
    /* Responsive grid: buttons arranged three per row on larger screens */
    .grid-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }
    .button {
      background-color: #007bff;
      color: white;
      padding: 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      text-align: center;
      transition: background-color 0.2s ease;
    }
    .button:hover {
      background-color: #0056b3;
    }
    .small-button {
      background-color: #6c757d;
      font-size: 14px;
      padding: 10px;
    }
    /* Details box styling */
    #details {
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 4px;
      background-color: #f8f9fa;
      margin-bottom: 20px;
      position: relative;
    }
    #collapseDetails {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
    }
    /* Red Gap Information box just under the description */
    #gapInfo {
      background-color: #ffe6e6;
      border: 1px solid #dc3545;
      color: #a70000;
      padding: 10px;
      margin: 10px 0;
      display: block; /* visible by default */
    }
    /* Ask AI Section styling */
    #askAISection {
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 4px;
      background-color: #f0f0f0;
      margin-top: 30px;
      text-align: center;
    }
    #exhaustiveQuery {
      width: 100%;
      height: 80px;
      margin-top: 10px;
      display: none;
    }
    #copyQueryBtn {
      background-color: #28a745;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
      display: none;
    }
    .link-buttons a {
      display: inline-block;
      margin: 5px;
      padding: 8px 12px;
      background-color: #007bff;
      color: white;
      text-decoration: none;
      border-radius: 4px;
    }
    .link-buttons a:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>High Impact Shared Savings</h1>
    <p>Click one of the topâ€‘tier buttons to display the full guideline details (with gap information). You can then use the "Ask AI" section to get the exclusion diagnosis codes (separated by OR) for use in Epic.</p>

    <!-- Top-Tier Buttons -->
    <div class="grid-buttons" id="highImpactButtons">
      <!-- Order of buttons (measure IDs) -->
      <button class="button" data-measure="KED">Kidney Eval</button>
      <button class="button" data-measure="CMA">Chol Adherence</button>
      <button class="button" data-measure="SUPD">Statin Use</button>
      <button class="button" data-measure="AIS-E">Adult Immuni</button>
      <button class="button" data-measure="GSD">Diabetes</button>
      <button class="button" data-measure="EED">Eye Exam</button>
      <button class="button" data-measure="DMA">Med Adherence (Diabetes)</button>
      <button class="button" data-measure="COL-E">Colon Screen</button>
      <button class="button" data-measure="BCS-E">Mammogram</button>
      <button class="button" data-measure="CBP">HTN</button>
      <button class="button" data-measure="AMM">Med Management</button>
      <button class="button" data-measure="TRC">Med Rec</button>
      <button class="button" data-measure="FMC">Follow Up Visits</button>
    </div>

    <!-- Also Ran Buttons (secondary, smaller) -->
    <div class="grid-buttons" id="alsoRanButtons">
      <button class="button small-button" data-measure="CWP">Pharyngitis</button>
      <button class="button small-button" data-measure="URI">Upper Respiratory</button>
      <button class="button small-button" data-measure="AMR">Asthma Med Ratio</button>
      <button class="button small-button" data-measure="CCS">Cervical Cancer</button>
      <button class="button small-button" data-measure="CHL">Chlamydia</button>
      <button class="button small-button" data-measure="POLY-ACH">Poly ACH</button>
      <button class="button small-button" data-measure="POLY-CNS">Poly CNS</button>
      <button class="button small-button" data-measure="SPD">Statin (Diabetes)</button>
      <button class="button small-button" data-measure="SUPD">Statin Use (Diabetes)</button>
      <button class="button small-button" data-measure="DMA">Med Adherence (Diabetes)</button>
      <button class="button small-button" data-measure="PCR">Readmissions</button>
    </div>

    <!-- Guideline Details Display -->
    <div id="details">
      <button id="collapseDetails">Collapse</button>
      <div id="guidelineDetails">
        <!-- This area will show the bulleted JSON details at the very top -->
        <p>Please click a button above to display the guideline details.</p>
      </div>
      <!-- Gap Information (in red, directly under the description) -->
      <div id="gapInfo">
        <p><strong>Gap Information:</strong> <span id="gapText">[Gap info here]</span></p>
        <button id="hideGapBtn" class="button small-button" style="background-color:#dc3545;">Hide Gap Info</button>
      </div>
    </div>

    <!-- Ask AI Section -->
    <div id="askAISection">
      <h3>Ask AI for Exclusion Diagnosis Codes</h3>
      <p>This will compile the exclusion diagnosis codes for the displayed guideline, separated by "OR".</p>
      <button id="askAIBtn" class="button small-button">Get Exclusion Codes</button>
      <textarea id="exhaustiveQuery" placeholder="Exclusion codes will appear here..." style="display:none;"></textarea>
      <button id="copyQueryBtn" style="display:none;">Copy Query</button>
      <div class="link-buttons">
        <a href="https://www.openaccessgovernment.org/evidence" target="_blank">Open Evidence</a>
        <a href="https://www.perplexity.ai" target="_blank">Perplexity</a>
        <a href="https://chat.openai.com" target="_blank">ChatGPT</a>
        <a href="https://gemini.google.com" target="_blank">Gemini</a>
        <a href="https://www.deepseek.ai" target="_blank">DeepSeek</a>
      </div>
    </div>
  </div>

  <script>
    // Global variable to store the guidelines JSON
    let medicalData = {};
    // Global variable to store the currently displayed guideline
    let currentGuideline = null;

    // Load JSON data from rules.json
    fetch('rules.json')
      .then(response => {
        if (!response.ok) {
          throw new Error("Error loading JSON: " + response.statusText);
        }
        return response.json();
      })
      .then(data => {
        medicalData = data;
        console.log("Loaded rules.json:", medicalData);
      })
      .catch(error => console.error(error));

    // Display guideline details for a given measure ID
    function displayGuideline(measureID) {
      const guidelines = medicalData.conditions;
      let found = null;
      for (const key in guidelines) {
        if (guidelines[key].measure_id === measureID) {
          found = { title: key, ...guidelines[key] };
          break;
        }
      }
      currentGuideline = found; // store for later use
      const detailsDiv = document.getElementById("guidelineDetails");
      if (found) {
        // Bulleted JSON details at the very top
        detailsDiv.innerHTML = `
          <div class="guideline">
            <h3>${found.title} (<em>${found.measure_id}</em>)</h3>
            <ul>
              <li><strong>Description:</strong> ${found.description}</li>
              <li><strong>Measurement Period:</strong> ${found.measurement_period}</li>
              <li><strong>Ages:</strong> ${found.ages}</li>
              <li><strong>Denominator Exclusions:</strong> ${found.denominator_exclusions.join('; ')}</li>
            </ul>
          </div>
        `;
        // Show gap information (methods to close gap) in red, right under the description.
        document.getElementById("gapText").innerText = found.methods_to_close_gap.join('; ');
        document.getElementById("gapInfo").style.display = "block";
      } else {
        detailsDiv.innerHTML = `<p>No details found for measure ${measureID}.</p>`;
        hideGapInfo();
      }
    }

    // Hide the gap information section
    function hideGapInfo() {
      document.getElementById("gapInfo").style.display = "none";
    }

    // Toggle collapse/expand for the details box
    document.getElementById("collapseDetails").addEventListener("click", function() {
      const detailsDiv = document.getElementById("guidelineDetails");
      if (detailsDiv.style.display === "none") {
        detailsDiv.style.display = "block";
        this.innerText = "Collapse";
      } else {
        detailsDiv.style.display = "none";
        this.innerText = "Expand";
      }
    });

    // Attach event listeners to all buttons (both top-tier and also ran)
    document.querySelectorAll('button[data-measure]').forEach(button => {
      button.addEventListener('click', function() {
        const measureID = this.getAttribute('data-measure');
        displayGuideline(measureID);
        // Hide the exhaustive query when a new guideline is selected
        document.getElementById("exhaustiveQuery").style.display = "none";
        document.getElementById("copyQueryBtn").style.display = "none";
      });
    });

    // Ask AI Section: compile the exclusion diagnosis codes separated by " OR "
    document.getElementById("askAIBtn").addEventListener("click", function() {
      if (!currentGuideline || !currentGuideline.denominator_exclusions) {
        alert("No guideline selected or no exclusions available.");
        return;
      }
      const codes = currentGuideline.denominator_exclusions.map(code => code.trim()).join(' OR ');
      const txtArea = document.getElementById("exhaustiveQuery");
      txtArea.value = codes;
      txtArea.style.display = "block";
      document.getElementById("copyQueryBtn").style.display = "block";
    });

    // Copy exhaustive query text to clipboard
    document.getElementById("copyQueryBtn").addEventListener("click", function() {
      const txtArea = document.getElementById("exhaustiveQuery");
      txtArea.select();
      document.execCommand("copy");
      alert("Exclusion diagnosis query copied to clipboard!");
    });
  </script>
</body>
</html>
