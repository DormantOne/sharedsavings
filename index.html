<!DOCTYPE html>
<html lang="en">
<head>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta charset="utf-8"/>
  <title>Medical Guideline Query</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { max-width: 800px; margin: auto; }
    textarea { width: 100%; height: 100px; margin-top: 10px; }
    button { margin-top: 10px; padding: 10px 15px; font-size: 16px; }
    .output { margin-top: 20px; padding: 10px; border: 1px solid #ddd; background-color: #f9f9f9; }
    .json-output { margin-top: 20px; padding: 10px; border: 1px solid #ccc; background-color: #eef; }
    ul { margin: 0; padding-left: 20px; }
    li { margin-bottom: 5px; }
  </style>
  <!-- Import CryptoJS for AES decryption -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Medical Guideline Query</h1>
    <h6>Ask about conditions and get relevant guideline details</h6>
    
    <!-- Code Verification Section -->
    <div id="codeVerification">
      <p>To get the Company-generated code 'code engine', visit:</p>
      <a href="https://teams.microsoft.com/l/entity/a6b63365-31a4-4f43-92ec-710b71557af9/_djb2_msteams_prefix_3260863391?context=%7B%22channelId%22%3A%2219%3Aqj6QKba__DKmVPDBVyDkJ-Iz7U7M8pyl3BJZZPY_EX41%40thread.tacv2%22%7D&tenantId=8b3dd73e-4e72-4679-b191-56da1588712b" target="_blank">Get Company Code</a>
      <h2>Verify Your Code</h2>
      <input id="userCode" placeholder="Enter your code here" style="width: 95%; padding: 10px;" type="text"/>
      <button onclick="getVerificationCode()">Verify Code</button>
      <p id="result"></p>
    </div>

    <!-- Query Input -->
    <textarea disabled id="queryInput" placeholder="Enter your question here"></textarea>
    <button disabled id="findButton" onclick="processQuery()">Find Answer</button>

    <!-- AI Response Output -->
    <div class="output" id="aiOutput"></div>

    <!-- JSON Segments Display -->
    <div class="json-output" id="jsonSegments"></div>
  </div>

  <script>
    // ----------------------------------------------------
    // API Key Decryption & Code Verification (Base Code)
    // ----------------------------------------------------
    // Encrypted API Key (replace with your own encrypted string)
    const encryptedAPIKey = `JOzvSNtkCCIZX8YFcGL4/cWSwC9pyDKTstx3bLRwvAEllzQRMaH+bVk0gYBnp6XNsedYU98XZGCetlJfsCRUAQ==`;
    let apiKey = null;

    function unlockFeatures(decryptionKey) {
      if (!decryptionKey) {
        document.getElementById('result').innerText = "Decryption key not found.";
        return;
      }
      try {
        const parsedKey = CryptoJS.enc.Utf8.parse(decryptionKey);
        const decryptedAPIKeyBytes = CryptoJS.AES.decrypt(encryptedAPIKey.trim(), parsedKey, {
          mode: CryptoJS.mode.ECB,
          padding: CryptoJS.pad.Pkcs7
        });
        const decryptedAPIKey = decryptedAPIKeyBytes.toString(CryptoJS.enc.Utf8);
        if (!decryptedAPIKey) throw new Error("Incorrect decryption key for API key.");

        apiKey = decryptedAPIKey;
        document.getElementById('result').innerText = "Verification successful. You can now use the application.";
        document.getElementById('queryInput').disabled = false;
        document.getElementById('findButton').disabled = false;
        document.getElementById('codeVerification').style.display = 'none';
      } catch (error) {
        console.error("Decryption error:", error);
        document.getElementById('result').innerText = "Failed to decrypt API key. Please try again.";
      }
    }

    async function getVerificationCode() {
      const userCode = document.getElementById('userCode').value.trim();
      try {
        // Use your working verification endpoint
        const response = await fetch('https://verifycode-u7nxzgzwjq-uc.a.run.app/?code=' + userCode);
        if (!response.ok) throw new Error("Failed to verify the code");
        const result = await response.json();

        if (result.message === "Code verified!") {
          localStorage.setItem('userCode', userCode);
          document.getElementById('result').innerText = "Code verified successfully!";
          unlockFeatures(result.decryptionKey);
          document.getElementById('codeVerification').style.display = 'none';
        } else {
          document.getElementById('result').innerText = "Incorrect code. Please try again.";
        }
      } catch (error) {
        console.error("Verification error:", error);
        document.getElementById('result').innerText = "Error verifying the code.";
      }
    }

    // ----------------------------------------------------
    // Load Medical Guidelines JSON Data from rules.json
    // ----------------------------------------------------
    // Instead of an inline definition, we fetch the JSON from an adjacent file.
    let medicalData = {};
    fetch('rules.json')
      .then(response => {
        if (!response.ok) {
          throw new Error("Network response was not ok " + response.statusText);
        }
        return response.json();
      })
      .then(data => {
        medicalData = data;
        console.log("Loaded rules.json:", medicalData);
      })
      .catch(error => {
        console.error("Error loading rules.json:", error);
      });

    // ----------------------------------------------------
    // First Pass: Collect Relevant Guideline IDs Using GPT‑3.5
    // ----------------------------------------------------
async function getRelevantMeasureIDs(query) {
  // We'll create a reduced JSON object from medicalData.conditions.
  const reducedData = Object.keys(medicalData.conditions).reduce((acc, key) => {
    acc[key] = {
      measure_id: medicalData.conditions[key].measure_id,
      keywords: medicalData.conditions[key].keywords
    };
    return acc;
  }, {});

  // Revised prompt:
  const firstPassPrompt = [
    {
      role: "system",
      content: "You are an AI that examines a JSON object of medical guidelines. Each guideline has a 'measure_id' and a 'keywords' array. The user query may contain a specific keyword. For each guideline in the JSON, if any of its keywords (case-insensitive) contain the word 'mammogram' or are clearly related (for example, if the guideline is about breast cancer screening), then output its measure_id enclosed in double square brackets (e.g., [[BCS-E]]). Output one measure id per line. If none of the guidelines are relevant, output an empty list []. Do not output any additional text."
    },
    {
      role: "user",
      content: `User Query: "${query}"\n\nMedical Guidelines JSON (only keys, measure_id, and keywords):\n${JSON.stringify(reducedData, null, 2)}`
    }
  ];

  // Log the prompt
  console.log("First Pass Prompt Sent to GPT-3.5:", JSON.stringify(firstPassPrompt, null, 2));

  // Call the OpenAI API
  const gpt35Response = await callOpenAI(firstPassPrompt, "gpt-3.5-turbo");

  // Log the raw response
  console.log("Raw GPT-3.5 Response:", gpt35Response);

  // Use a regex to extract measure IDs enclosed in [[ ... ]]
  const idRegex = /\[\[([^\]]+)\]\]/g;
  let match;
  const relevantIDs = [];
  while ((match = idRegex.exec(gpt35Response)) !== null) {
    relevantIDs.push(match[1].trim());
  }

  console.log("Extracted Relevant IDs:", relevantIDs);
  if (relevantIDs.length === 0) {
    console.error("No measure IDs found in GPT-3.5 response.");
  }

  return relevantIDs;
}

    // ----------------------------------------------------
    // Second Pass: Answer the Query Using GPT‑4
    // ----------------------------------------------------
    async function getDetailedAnswer(query, relevantIDs) {
      // Gather the full JSON segments for each selected guideline.
      const relevantSegments = {};
      relevantIDs.forEach(id => {
        for (const key in medicalData) {
          if (medicalData[key].measure_id === id) {
            relevantSegments[id] = medicalData[key];
            break;
          }
        }
      });

      const detailedPrompt = [
        { role: "system", content: "You are an AI expert in medical guidelines. Given a user's query and the relevant guideline JSON segments (each identified by its measure_id), provide a concise answer to the query. Then, list the details of each relevant guideline as bullet points. Use the measure_id as the handle for each guideline. The response should include an 'Answer' section and a 'Details' section with bullet points." },
        { role: "user", content: `User Query: "${query}"\n\nRelevant Guidelines:\n${JSON.stringify(relevantSegments, null, 2)}` }
      ];

      return await callOpenAI(detailedPrompt, "gpt-4");
    }

    // ----------------------------------------------------
    // Process Query: Orchestrates Both Passes
    // ----------------------------------------------------
    async function processQuery() {
      const query = document.getElementById("queryInput").value.trim();
      if (!query) {
        alert("Please enter a question.");
        return;
      }
      if (!apiKey) {
        alert("API key not available. Please verify your code.");
        return;
      }
      // Ensure that medicalData has been loaded
      if (!Object.keys(medicalData).length) {
        alert("Guideline data not loaded yet. Please try again in a moment.");
        return;
      }

      document.getElementById("aiOutput").innerHTML = "Processing...";
      document.getElementById("jsonSegments").innerHTML = "";

      try {
        // First pass: get relevant measure IDs based on keywords (via GPT‑3.5)
        const relevantIDs = await getRelevantMeasureIDs(query);
        console.log("Relevant measure IDs:", relevantIDs);

        if (relevantIDs.length === 0) {
          document.getElementById("aiOutput").innerHTML = "No relevant guidelines found.";
          return;
        }

        // Second pass: get the detailed answer from GPT‑4 using the full JSON segments.
        const detailedAnswer = await getDetailedAnswer(query, relevantIDs);
        document.getElementById("aiOutput").innerHTML = `<strong>AI Response:</strong><br>${detailedAnswer}`;

        // Also display the relevant JSON segments in bullet-point format.
        let jsonHtml = `<strong>Relevant Guidelines Details:</strong><ul>`;
        relevantIDs.forEach(id => {
          for (const key in medicalData) {
            if (medicalData[key].measure_id === id) {
              const guideline = medicalData[key];
              jsonHtml += `<li>
                <strong>${guideline.measure_id}:</strong> ${key}<br>
                <strong>Description:</strong> ${guideline.description}<br>
                <strong>Measurement Period:</strong> ${guideline.measurement_period}<br>
                <strong>Ages:</strong> ${guideline.ages}<br>
                <strong>Best Practices:</strong>
                <ul>${guideline.best_practices.map(practice => `<li>${practice}</li>`).join('')}</ul>
              </li>`;
              break;
            }
          }
        });
        jsonHtml += `</ul>`;
        document.getElementById("jsonSegments").innerHTML = jsonHtml;
      } catch (error) {
        console.error("Error processing query:", error);
        document.getElementById("aiOutput").innerHTML = "An error occurred.";
      }
    }

    // ----------------------------------------------------
    // Function to Call OpenAI API
    // ----------------------------------------------------
    async function callOpenAI(messages, model) {
      if (!apiKey) {
        throw new Error("API key not available. Please verify your code.");
      }
      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: model,
          messages: messages,
          temperature: 0.2,
          max_tokens: 500
        })
      });
      const data = await response.json();
      if (data.error) {
        throw new Error(data.error.message);
      }
      return data.choices[0].message.content;
    }
  </script>
</body>
</html>
