<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>High Impact Shared Savings</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .container {
      max-width: 1000px;
      margin: auto;
    }
    h1, h2, h3 {
      margin: 10px 0;
    }
    /* Details box at the very top (hidden by default) */
    #details {
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 4px;
      background-color: #f8f9fa;
      margin-bottom: 20px;
      display: none;
      position: relative;
    }
    /* Red banner for gap information at the top of the details box */
    #gapBanner {
      background-color: #ffe6e6;
      color: #a70000;
      padding: 10px;
      border: 1px solid #dc3545;
      border-radius: 4px;
      margin-bottom: 10px;
      font-weight: bold;
    }
    /* Button to close the entire details box */
    #closeDetailsBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
    }
    /* Button to toggle extra details */
    #toggleExtraBtn {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
      margin-top: 10px;
    }
    /* Extra details area (hidden by default) */
    #extraDetails {
      display: none;
      margin-top: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      background-color: #e9ecef;
      border-radius: 4px;
    }
    /* Responsive grid for buttons */
    .grid-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }
    .button {
      background-color: #007bff;
      color: white;
      padding: 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      text-align: center;
      transition: background-color 0.2s ease;
    }
    .button:hover {
      background-color: #0056b3;
    }
    .small-button {
      background-color: #6c757d;
      font-size: 14px;
      padding: 10px;
    }
    /* Ask AI Section styling */
    #askAISection {
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 4px;
      background-color: #f0f0f0;
      margin-top: 30px;
      text-align: center;
    }
    #exhaustiveQuery {
      width: 100%;
      height: 80px;
      margin-top: 10px;
      display: none;
    }
    #copyQueryBtn {
      background-color: #28a745;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
      display: none;
    }
    .link-buttons a {
      display: inline-block;
      margin: 5px;
      padding: 8px 12px;
      background-color: #007bff;
      color: white;
      text-decoration: none;
      border-radius: 4px;
    }
    .link-buttons a:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>High Impact Shared Savings</h1>
    <p>Click one of the topâ€‘tier buttons below to display the full guideline details. The details box (with a red Gap Information banner at the very top) will appear above the buttons. You can collapse the box entirely, and there is an option to expand and view all extra details. At the bottom, the "Ask AI" section will compile the exclusion diagnosis codes (separated by "OR") for use in Epic.</p>

    <!-- Details Box (hidden by default) -->
    <div id="details">
      <button id="closeDetailsBtn">Close</button>
      <div id="gapBanner">Gap Information: <span id="gapText">[Gap info]</span></div>
      <div id="guidelineDetails">
        <!-- Bulleted JSON details will be shown here -->
        <ul>
          <li>Please select a guideline.</li>
        </ul>
      </div>
      <button id="toggleExtraBtn">Show Extra Details</button>
      <div id="extraDetails">
        <!-- Extra details (e.g., Denominator Exclusions, Best Practices) -->
        <ul>
          <li>[Extra details here]</li>
        </ul>
      </div>
    </div>

    <!-- Top-Tier Buttons -->
    <div class="grid-buttons" id="highImpactButtons">
      <!-- Order: Kidney Eval, Chol Adherence, Statin Use, Statin Diabetes Med Adherence, Readmissions, Adult Immuni, Diabetes, Eye Exam, Colon Screen, Mammogram, HTN, Med Management, Med Rec, Follow Up Visits -->
      <button class="button" data-measure="KED">Kidney Eval</button>
      <button class="button" data-measure="CMA">Chol Adherence</button>
      <button class="button" data-measure="SUPD">Statin Use</button>
      <button class="button" data-measure="DMA">Med Adherence (Diabetes)</button>
      <button class="button" data-measure="PCR">Readmissions</button>
      <button class="button" data-measure="AIS-E">Adult Immuni</button>
      <button class="button" data-measure="GSD">Diabetes</button>
      <button class="button" data-measure="EED">Eye Exam</button>
      <button class="button" data-measure="COL-E">Colon Screen</button>
      <button class="button" data-measure="BCS-E">Mammogram</button>
      <button class="button" data-measure="CBP">HTN</button>
      <button class="button" data-measure="AMM">Med Management</button>
      <button class="button" data-measure="TRC">Med Rec</button>
      <button class="button" data-measure="FMC">Follow Up Visits</button>
    </div>

    <!-- Also Ran Buttons (secondary, smaller) -->
    <div class="grid-buttons" id="alsoRanButtons">
      <button class="button small-button" data-measure="CWP">Pharyngitis</button>
      <button class="button small-button" data-measure="URI">Upper Respiratory</button>
      <button class="button small-button" data-measure="AMR">Asthma Med Ratio</button>
      <button class="button small-button" data-measure="CCS">Cervical Cancer</button>
      <button class="button small-button" data-measure="CHL">Chlamydia</button>
      <button class="button small-button" data-measure="POLY-ACH">Poly ACH</button>
      <button class="button small-button" data-measure="POLY-CNS">Poly CNS</button>
      <button class="button small-button" data-measure="SPD">Statin (Diabetes)</button>
    </div>

    <!-- Ask AI Section -->
    <div id="askAISection">
      <h3>Ask AI for Exclusion Diagnosis Codes</h3>
      <p>This compiles the exclusion codes for the displayed guideline, separated by "OR". Paste the result into Epic to check for exclusions.</p>
      <button id="askAIBtn" class="button small-button">Get Exclusion Codes</button>
      <textarea id="exhaustiveQuery" placeholder="Exclusion codes will appear here..." style="display:none;"></textarea>
      <button id="copyQueryBtn" style="display:none;">Copy Query</button>
      <div class="link-buttons">
        <a href="https://www.openaccessgovernment.org/evidence" target="_blank">Open Evidence</a>
        <a href="https://www.perplexity.ai" target="_blank">Perplexity</a>
        <a href="https://chat.openai.com" target="_blank">ChatGPT</a>
        <a href="https://gemini.google.com" target="_blank">Gemini</a>
        <a href="https://www.deepseek.ai" target="_blank">DeepSeek</a>
      </div>
    </div>
  </div>

  <script>
    // Global variable for JSON data and current guideline.
    let medicalData = {};
    let currentGuideline = null;

    // Load guidelines from rules.json.
    fetch('rules.json')
      .then(response => {
        if (!response.ok) throw new Error("Error loading JSON: " + response.statusText);
        return response.json();
      })
      .then(data => {
        medicalData = data;
        console.log("Loaded rules.json:", medicalData);
      })
      .catch(error => console.error(error));

    // Display guideline details for a given measure ID.
    function displayGuideline(measureID) {
      const guidelines = medicalData.conditions;
      let found = null;
      for (const key in guidelines) {
        if (guidelines[key].measure_id === measureID) {
          found = { title: key, ...guidelines[key] };
          break;
        }
      }
      currentGuideline = found;
      const detailsDiv = document.getElementById("guidelineDetails");
      const extraDiv = document.getElementById("extraDetails");
      if (found) {
        // Display main bullet points at the very top.
        detailsDiv.innerHTML = `
          <ul>
            <li><strong>Title:</strong> ${found.title}</li>
            <li><strong>Measure ID:</strong> ${found.measure_id}</li>
            <li><strong>Description:</strong> ${found.description}</li>
            <li><strong>Measurement Period:</strong> ${found.measurement_period}</li>
            <li><strong>Ages:</strong> ${found.ages}</li>
          </ul>
        `;
        // Extra details (denominator exclusions and best practices) in the extra area.
        extraDiv.innerHTML = `
          <ul>
            <li><strong>Denominator Exclusions:</strong> ${found.denominator_exclusions.join('; ')}</li>
            <li><strong>Best Practices:</strong>
              <ul>
                ${found.best_practices.map(practice => `<li>${practice}</li>`).join('')}
              </ul>
            </li>
          </ul>
        `;
        // Always display the details box.
        document.getElementById("details").style.display = "block";
        // Set the gap banner using the methods to close gap.
        document.getElementById("gapText").innerText = found.methods_to_close_gap.join('; ');
      } else {
        detailsDiv.innerHTML = `<p>No details found for measure ${measureID}.</p>`;
        extraDiv.innerHTML = "";
        document.getElementById("gapInfo").style.display = "none";
      }
    }

    // Toggle extra details (show/hide).
    document.getElementById("toggleExtraBtn").addEventListener("click", function() {
      const extraDiv = document.getElementById("extraDetails");
      if (extraDiv.style.display === "none" || extraDiv.style.display === "") {
        extraDiv.style.display = "block";
        this.innerText = "Hide Extra Details";
      } else {
        extraDiv.style.display = "none";
        this.innerText = "Show Extra Details";
      }
    });

    // Close the entire details box.
    document.getElementById("closeDetailsBtn").addEventListener("click", function() {
      document.getElementById("details").style.display = "none";
      currentGuideline = null;
    });

    // Attach event listeners to all guideline buttons.
    document.querySelectorAll('button[data-measure]').forEach(button => {
      button.addEventListener('click', function() {
        const measureID = this.getAttribute('data-measure');
        displayGuideline(measureID);
        // Hide the exhaustive query area if visible.
        document.getElementById("exhaustiveQuery").style.display = "none";
        document.getElementById("copyQueryBtn").style.display = "none";
      });
    });

    // Ask AI Section: Compile exclusion diagnosis codes separated by " OR ".
    document.getElementById("askAIBtn").addEventListener("click", function() {
      if (!currentGuideline || !currentGuideline.denominator_exclusions) {
        alert("No guideline selected or no exclusions available.");
        return;
      }
      const codes = currentGuideline.denominator_exclusions.map(code => code.trim()).join(' OR ');
      const txtArea = document.getElementById("exhaustiveQuery");
      txtArea.value = codes;
      txtArea.style.display = "block";
      document.getElementById("copyQueryBtn").style.display = "block";
    });

    // Copy exhaustive query text to clipboard.
    document.getElementById("copyQueryBtn").addEventListener("click", function() {
      const txtArea = document.getElementById("exhaustiveQuery");
      txtArea.select();
      document.execCommand("copy");
      alert("Exclusion diagnosis query copied to clipboard!");
    });
  </script>
</body>
</html>
